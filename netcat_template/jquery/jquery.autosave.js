(function($){$.fn.autosave=function(options){var identifier=$.map(this,function(obj,i){return $(obj).attr("id")+$(obj).attr("name")}).join();var autosave=Autosave.getInstance(identifier);autosave.protect(this,options);return autosave;};var dataSender={};dataSender.set=function(key,value){};dataSender.get=function(key){};dataSender.remove=function(key){};Autosave=(function(){var params={instantiated:[],started:[]};function init(){return{stopTimer:function(){this.targets=[];clearTimeout(this.timeoutId);clearTimeout(this.timeoutInnerId);},setInstanceIdentifier:function(identifier){this.identifier=identifier},getInstanceIdentifier:function(){return this.identifier;},setInitialOptions:function(options){var defaults={excludeFields:[],customKeySuffix:"",locationBased:false,timeout:0,autoRelease:true,onSave:function(){},onBeforeRestore:function(){},onRestore:function(){},onRelease:function(){}};this.options=this.options||$.extend(defaults,options);this.dataSender=dataSender;},setOptions:function(options){this.options=this.options||this.setInitialOptions(options);this.options=$.extend(this.options,options);},protect:function(targets,options){this.setOptions(options);targets=targets||{};var self=this;this.targets=this.targets||[];this.href=location.hostname+location.pathname+location.search+location.hash;this.targets=$.merge(this.targets,targets);this.targets=$.unique(this.targets);this.targets=$(this.targets);if(self.options.restore==true){self.restoreAllData();}if(self.isCKEditorPresent()){var intervalId=setInterval(function(){if(CKEDITOR.isLoaded){clearInterval(intervalId);self.bindSaveData();params.started[self.getInstanceIdentifier()]=true;}},100);}else{self.bindSaveData();params.started[self.getInstanceIdentifier()]=true;}},isCKEditorPresent:function(){if(this.isCKEditorExists()){CKEDITOR.isLoaded=false;CKEDITOR.on('instanceReady',function(){CKEDITOR.isLoaded=true;});var self=this;var cke_element_exsts=false;self.targets.each(function(){self.findFieldsToProtect($(this)).each(function(){var field=$(this);if($("#cke_"+field.attr('id')).length){cke_element_exsts=true;}});});return cke_element_exsts;}else{return false;}},isCKEditorExists:function(){return typeof CKEDITOR!="undefined";},findFieldsToProtect:function(target){return target.find(":input").not(":submit").not(":reset").not(":button").not(":file").not(":password").not(":disabled").not("[readonly]");},bindSaveData:function(){var self=this;if(self.options.timeout){self.saveDataByTimeout();if(self.options.noactive==1){self.targets.each(function(){self.findFieldsToProtect($(this)).each(function(){if($.inArray(this,self.options.excludeFields)!==-1){return true;}var field=$(this);self.bindResetTimerOnChange(field);});});}}if(self.options.onkeys)self.targets.each(function(){var targetFormIdAndName=$(this).attr("id")+$(this).attr("name");self.findFieldsToProtect($(this)).each(function(){if($.inArray(this,self.options.excludeFields)!==-1){return true;}var field=$(this);var prefix=(self.options.locationBased?self.href:"")+targetFormIdAndName+field.attr("name")+self.options.customKeySuffix;if(field.is(":text")||field.is("textarea")){if(!self.options.timeout){self.bindSaveDataImmediately(field,prefix);}}self.bindSaveDataOnChange(field);});});},saveAllData:function(){var self=this;self.targets.each(function(){var targetFormIdAndName=$(this).attr("id")+$(this).attr("name");var multiCheckboxCache={};self.findFieldsToProtect($(this)).each(function(){var field=$(this);if($.inArray(this,self.options.excludeFields)!==-1||field.attr("name")===undefined){return true;}var prefix=(self.options.locationBased?self.href:"")+targetFormIdAndName+field.attr("name")+self.options.customKeySuffix;var value=field.val();if(field.is(":checkbox")){if(field.attr("name").indexOf("[")!==-1){if(multiCheckboxCache[field.attr("name")]===true){return;}value=[];$("[name='"+field.attr("name")+"']:checked").each(function(){value.push($(this).val());});multiCheckboxCache[field.attr("name")]=true;}else{value=field.is(":checked");}self.saveToStorage(prefix,value,false);}else if(field.is(":radio")){if(field.is(":checked")){value=field.val();self.saveToStorage(prefix,value,false);}}else{if(self.isCKEditorExists()){var editor;if(editor=CKEDITOR.instances[field.attr("name")]||CKEDITOR.instances[field.attr("id")]){editor.updateElement();self.saveToStorage(prefix,field.val(),false);}else{self.saveToStorage(prefix,value,false);}}else{self.saveToStorage(prefix,value,false);}}});});self.options.onSave.call(self);},restoreAllData:function(){var self=this;var restored=false;self.targets.each(function(){var target=$(this);var targetFormIdAndName=$(this).attr("id")+$(this).attr("name");self.findFieldsToProtect(target).each(function(){if($.inArray(this,self.options.excludeFields)!==-1){return true;}var field=$(this);var prefix=(self.options.locationBased?self.href:"")+targetFormIdAndName+field.attr("name")+self.options.customKeySuffix;var resque=(typeof self.options.fields_to_restore[field.attr("name")]!=='undefined')?self.options.fields_to_restore[field.attr("name")]:null;if(resque!==null){self.restoreFieldsData(field,resque);restored=true;}});});},restoreFieldsData:function(field,resque){if(field.attr("name")===undefined){return false;}if(field.is(":checkbox")&&resque!=="false"&&field.attr("name").indexOf("[")===-1){field.attr("checked","checked");}else if(field.is(":checkbox")&&resque==="false"&&field.attr("name").indexOf("[")===-1){field.removeAttr("checked");}else if(field.is(":radio")){if(field.val()===resque){field.attr("checked","checked");}}else if(field.attr("name").indexOf("[")===-1){field.val(resque);}else{resque=resque.split(",");field.val(resque);}},bindSaveDataImmediately:function(field,prefix){var self=this;if('onpropertychange'in field){field.get(0).onpropertychange=function(){self.saveToStorage(prefix,field.val());};}else{field.get(0).oninput=function(){self.saveToStorage(prefix,field.val());};}if(this.isCKEditorExists()){var editor;if(editor=CKEDITOR.instances[field.attr("name")]||CKEDITOR.instances[field.attr("id")]){editor.document.on('keyup',function(){editor.updateElement();self.saveToStorage(prefix,field.val());});}}},saveToStorage:function(key,value,fireCallback){fireCallback=fireCallback===undefined?true:fireCallback;this.dataSender.set(key,value);if(fireCallback&&value!==""){this.options.onSave.call(this);}},bindSaveDataOnChange:function(field){var self=this;field.change(function(){self.saveAllData();});},resetTimer:function(self){if(nc_autosave_type==='timer'){clearTimeout(self.timeoutId);clearTimeout(self.timeoutInnerId);var targetForms=self.targets;self.timeoutId=setTimeout((function(){function timeout(){self.saveAllData();self.timeoutInnerId=setTimeout(timeout,self.options.timeout*1000);}return timeout;})(targetForms),self.options.timeout*1000);}},bindResetTimerOnChange:function(field){if(nc_autosave_type==='timer'){var self=this;if('onpropertychange'in field){field.get(0).onpropertychange=function(){self.resetTimer(self);};}else{field.get(0).oninput=function(){self.resetTimer(self);};}if(this.isCKEditorExists()){CKEDITOR.on('instanceReady',function(evt){var editor=evt.editor;if(editor=CKEDITOR.instances[field.attr("name")]||CKEDITOR.instances[field.attr("id")]){editor.document.on('keyup',function(){editor.updateElement();self.resetTimer(self);});}});}}},saveDataByTimeout:function(){var self=this;var targetForms=self.targets;self.timeoutId=setTimeout((function(){function timeout(){self.saveAllData();self.timeoutInnerId=setTimeout(timeout,self.options.timeout*1000);}return timeout;})(targetForms),self.options.timeout*1000);},bindReleaseData:function(){var self=this;self.targets.each(function(){var target=$(this);var formIdAndName=target.attr("id")+target.attr("name");$(this).bind("submit reset",function(){self.releaseData(formIdAndName,self.findFieldsToProtect(target));});});},manuallyReleaseData:function(){var self=this;self.targets.each(function(){var target=$(this);var formIdAndName=target.attr("id")+target.attr("name");self.releaseData(formIdAndName,self.findFieldsToProtect(target));});},releaseData:function(targetFormIdAndName,fieldsToProtect){var released=false;var self=this;params.started[self.getInstanceIdentifier()]=false;fieldsToProtect.each(function(){if($.inArray(this,self.options.excludeFields)!==-1){return true;}var field=$(this);var prefix=(self.options.locationBased?self.href:"")+targetFormIdAndName+field.attr("name")+self.options.customKeySuffix;self.dataSender.remove(prefix);released=true;});if(released){self.options.onRelease.call(self);}}};}return{getInstance:function(identifier){if(!params.instantiated[identifier]){params.instantiated[identifier]=init();params.instantiated[identifier].setInstanceIdentifier(identifier);params.instantiated[identifier].setInitialOptions();}if(identifier){return params.instantiated[identifier];}return params.instantiated[identifier];},free:function(){params={instantiated:[],started:[]};return null;}};})();})(jQuery);