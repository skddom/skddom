function nc_netshop_condition_editor(f){this.init(f)}
(function(f){var h=nc_netshop_condition_editor,d=h.prototype,b=nc_netshop_condition_messages,u=h.adminFilesPath=NETCAT_PATH+"admin/",l=h.filesPath=NETCAT_PATH+"modules/netshop/admin/condition/",i=h.dataPath=l+"data/";h.dataCache={};h.urls={SelectComponentList:i+"json/component_list.php",ObjectName:i+"json/object_name.php",SelectSubdivisionList:i+"json/subdivision_list.php?site_id=%siteId%",SelectItemPropertyList:i+"json/component_field_list.php",SelectFromClassifierList:i+"json/classifier_values.php",
UserName:i+"json/user_name.php",SelectUserGroupList:i+"json/user_group_list.php",SelectUserPropertyList:i+"json/user_field_list.php",SelectOrderStatusList:i+"json/order_status_list.php",SelectOrderPropertyList:i+"json/order_field_list.php?site_id=%siteId%",SelectDeliveryMethodList:i+"json/order_delivery_method_list.php?site_id=%siteId%",SelectPaymentMethodList:i+"json/order_payment_method_list.php?site_id=%siteId%"};h.loadingInProgress={};d.siteId=null;d.root=null;d.inputField=null;d.isInitializing=
!1;d.defaultChosenParams={disable_search_threshold:10,no_results_text:b.SEARCH_NO_RESULTS};d.conditionGroupsToShow=[];d.conditionGroupsToExclude=[];d.conditionsToExclude=[];d.itemProperties={};d.userProperties={};d.orderProperties={};var j=h.opEqNe={name:"op",type:"SimpleSelect",values:{eq:b.EQUALS,ne:b.NOT_EQUALS}},v=h.opContains={name:"op",type:"SimpleSelect",values:{contains:b.CONTAINS,notcontains:b.NOT_CONTAINS}},q=h.opString={name:"op",type:"SimpleSelect",values:{eq:b.EQUALS,ne:b.NOT_EQUALS,
contains:b.CONTAINS,notcontains:b.NOT_CONTAINS,begins:b.BEGINS_WITH}},g=h.opNumber={name:"op",type:"SimpleSelect",values:{ge:b.GREATER_OR_EQUALS,gt:b.GREATER_THAN,le:b.LESS_OR_EQUALS,lt:b.LESS_THAN,eq:b.EQUALS,ne:b.NOT_EQUALS}},r=h.opDateTime=g,i=h.opAll=f.extend({},q);f.extend(i.values,g.values);var o=h.makeSubdivisionField=function(a){return{name:a||"value",type:"SelectFromJson",source:h.urls.SelectSubdivisionList,placeholder:b.SELECT_SUBDIVISION}},p=h.makeComponentField=function(a){return{name:a||
"value",type:"SelectFromJson",source:h.urls.SelectComponentList,placeholder:b.SELECT_COMPONENT}};d.conditionTypes={item_component:{group:"GROUP_GOODS",label:"TYPE_COMPONENT",params:[b.TYPE_COMPONENT,j,p("value")]},item_sub:{group:"GROUP_GOODS",label:"TYPE_SUBDIVISION",params:[b.TYPE_SUBDIVISION,j,o("value")]},item_parentsub:{group:"GROUP_GOODS",label:"TYPE_SUBDIVISION_DESCENDANTS",params:[b.TYPE_SUBDIVISION_DESCENDANTS,j,o("value")]},item:{group:"GROUP_GOODS",label:"TYPE_ITEM",params:[b.TYPE_ITEM,
j,{name:"value",type:"SelectItem"}]},item_property:{group:"GROUP_GOODS",label:"TYPE_ITEM_FIELD",params:[b.TYPE_ITEM_FIELD,{name:"field",type:"SelectItemProperty"},{type:"ItemPropertyOptions"}]},user_group:{group:"GROUP_USER",label:"TYPE_USER_GROUP",params:[b.TYPE_USER_GROUP,j,{name:"value",type:"SelectFromJson",source:h.urls.SelectUserGroupList,placeholder:b.SELECT_USER_GROUP}]},user:{group:"GROUP_USER",label:"TYPE_USER",params:[b.TYPE_USER,j,{name:"value",type:"SelectUser"}]},user_created:{group:"GROUP_USER",
label:"TYPE_USER_CREATED",params:[b.TYPE_USER_CREATED,r,{name:"value",type:"DateTimeInput"}]},user_property:{group:"GROUP_USER",label:"TYPE_USER_FIELD",params:[b.TYPE_USER_FIELD,{name:"field",type:"SelectUserProperty"},{type:"UserPropertyOptions"}]},cart_totalprice:{group:"GROUP_CART",label:"TYPE_CART_SUM_WITH_ITEM_DISCOUNTS",params:[b.TYPE_CART_SUM_WITH_ITEM_DISCOUNTS,g,{name:"value",type:"Input",inputType:"number"}]},cart_sum:{group:"GROUP_CART",label:"TYPE_CART_SUM",params:[b.TYPE_CART_SUM,g,{name:"value",
type:"Input",inputType:"number"}]},cart_count:{group:"GROUP_CART",label:"TYPE_CART_POSITION_COUNT",params:[b.CART_POSITION_COUNT,g,{name:"value",type:"Input",inputType:"number"}]},cart_itemcomponent:{group:"GROUP_CART",label:"TYPE_CART_ITEM_COMPONENT",params:[b.CART_CONTAINS,g,{name:"qty",type:"Input",inputType:"number",value:1},b.CART_PIECES_OF_COMPONENT,p("component")]},cart_itemsub:{group:"GROUP_CART",label:"TYPE_CART_ITEM_SUBDIVISION",params:[b.CART_CONTAINS,g,{name:"qty",type:"Input",inputType:"number",
value:1},b.CART_PIECES_OF_ITEMS_FROM_SUBDIVISION,o("subdivision")]},cart_itemparentsub:{group:"GROUP_CART",label:"TYPE_CART_ITEM_SUBDIVISION_DESCENDANTS",params:[b.CART_CONTAINS,g,{name:"qty",type:"Input",inputType:"number",value:1},b.CART_PIECES_OF_ITEMS_FROM_SUBDIVISION_DESCENDANTS,o("subdivision")]},cart_item:{group:"GROUP_CART",label:"TYPE_CART_ITEM_COUNT",params:[b.CART_CONTAINS,g,{name:"qty",type:"Input",inputType:"number",value:1},b.CART_PIECES_OF,{name:"item",type:"SelectItem"}]},cart_itemproperty:{group:"GROUP_CART",
label:"TYPE_CART_ITEM_FIELD",params:[b.CART_CONTAINS,f.extend({},g,{name:"qty_op"}),{name:"qty",type:"Input",inputType:"number",value:1},b.CART_ITEM_FIELD,{name:"field",type:"SelectItemProperty"},{type:"ItemPropertyOptions"}]},cart_propertysum:{group:"GROUP_CART",label:"TYPE_CART_FIELD_SUM",params:[b.CART_FIELD_SUM,{name:"field",type:"SelectItemProperty"},g,{name:"value",type:"Input",inputType:"number"}]},cart_propertymin:{group:"GROUP_CART",label:"TYPE_CART_FIELD_MIN",params:[b.CART_FIELD_MIN,{name:"field",
type:"SelectItemProperty"},g,{name:"value",type:"Input",inputType:"number"}]},cart_propertymax:{group:"GROUP_CART",label:"TYPE_CART_FIELD_MAX",params:[b.CART_FIELD_MAX,{name:"field",type:"SelectItemProperty"},g,{name:"value",type:"Input",inputType:"number"}]},order_status:{group:"GROUP_ORDER",label:"TYPE_ORDER_STATUS",params:[b.TYPE_ORDER_STATUS,j,{name:"value",type:"SelectFromJson",source:h.urls.SelectOrderStatusList,placeholder:b.SELECT_ORDER_STATUS}]},order_property:{group:"GROUP_ORDER",label:"TYPE_ORDER_FIELD",
params:[b.TYPE_ORDER_FIELD,{name:"field",type:"SelectOrderProperty"},{type:"OrderPropertyOptions"}]},order_deliverymethod:{group:"GROUP_ORDER",label:"TYPE_ORDER_DELIVERY_METHOD",params:[b.TYPE_ORDER_DELIVERY_METHOD,j,{name:"value",type:"SelectFromJson",source:h.urls.SelectDeliveryMethodList,placeholder:b.SELECT_DELIVERY_METHOD}]},order_paymentmethod:{group:"GROUP_ORDER",label:"TYPE_ORDER_PAYMENT_METHOD",params:[b.TYPE_ORDER_PAYMENT_METHOD,j,{name:"value",type:"SelectFromJson",source:h.urls.SelectPaymentMethodList,
placeholder:b.SELECT_PAYMENT_METHOD}]},orders_sum:{group:"GROUP_ORDERS",label:"TYPE_ORDER_SUM_ALL_TIME",params:[b.TYPE_ORDER_SUM_ALL_TIME,g,{name:"value",type:"Input",inputType:"number"}]},orders_sumperiod:{group:"GROUP_ORDERS",label:"TYPE_ORDER_SUM_PERIOD",params:[b.ORDER_SUM_FOR_LAST,{name:"period_value",type:"Input",inputType:"number"},{name:"period_type",type:"SimpleSelect",values:{day:b.LAST_X_DAYS,week:b.LAST_X_WEEKS,month:b.LAST_X_MONTHS,year:b.LAST_X_YEARS}},g,{name:"value",type:"Input",inputType:"number"}]},
orders_sumdates:{group:"GROUP_ORDERS",label:"TYPE_ORDER_SUM_DATES",params:[b.ORDER_SUM_DATE_FROM,{name:"date_from",type:"DateTimeInput"},b.ORDER_SUM_DATE_TO,{name:"date_to",type:"DateTimeInput"},g,{name:"value",type:"Input",inputType:"number"}]},orders_count:{group:"GROUP_ORDERS",label:"TYPE_ORDER_COUNT",params:[b.TYPE_ORDER_COUNT,g,{name:"value",type:"Input",inputType:"number"}]},orders_component:{group:"GROUP_ORDERS",label:"TYPE_ORDERS_CONTAIN_COMPONENT",params:[b.TYPE_ORDERS_CONTAIN_COMPONENT,
p("value")]},orders_item:{group:"GROUP_ORDERS",label:"TYPE_ORDERS_CONTAIN_ITEM",params:[b.TYPE_ORDERS_CONTAIN_ITEM,{name:"value",type:"SelectItem"}]},datetime_dateinterval:{group:"GROUP_DATETIME",label:"TYPE_DATE_INTERVAL",params:[b.DATE_FROM,{name:"date_from",type:"DateTimeInput"},b.DATE_TO,{name:"date_to",type:"DateTimeInput"}]},datetime_dayofweek:{group:"GROUP_DATETIME",label:"TYPE_DAY_OF_WEEK",params:[b.DAY_OF_WEEK,j,{name:"value",type:"SimpleSelect",values:{1:b.MONDAY,2:b.TUESDAY,3:b.WEDNESDAY,
4:b.THURSDAY,5:b.FRIDAY,6:b.SATURDAY,7:b.SUNDAY}}]},datetime_timeinterval:{group:"GROUP_DATETIME",label:"TYPE_TIME_INTERVAL",params:[b.TIME_FROM,{name:"time_from",type:"Input",inputType:"time"},b.TIME_TO,{name:"time_to",type:"Input",inputType:"time"}]},valueof_cookie:{group:"GROUP_VALUEOF",label:"TYPE_COOKIE_VALUE",params:["$_COOKIE[&quot;",{name:"key",type:"Input"},"&quot;]",i,{name:"value",type:"Input"}]},valueof_session:{group:"GROUP_VALUEOF",label:"TYPE_SESSION_VALUE",params:["$_SESSION[&quot;",
{name:"key",type:"Input"},"&quot;]",i,{name:"value",type:"Input"}]},extension_function:{group:"GROUP_EXTENSION",label:"TYPE_USER_FUNCTION",params:[b.FUNCTION_CALL,{name:"function",type:"Input"},b.FUNCTION_RETURNS_TRUE]}};var s=function(a){if(!a.getBoundingClientRect)return f(a).offset();var c=document.body,e=document.documentElement,b=window.pageYOffset||e.scrollTop||c.scrollTop,c=e.clientTop||c.clientTop||0;return Math.round(a.getBoundingClientRect().top+b-c)},t=function(a,c){var e=c.chosen;setTimeout(function(){var a=
e.dropdown,a=s(a[0])+a.outerHeight(),c=f("body, html"),b=c.scrollTop()+f(window).height(),b=a-b;0<b&&(b=Math.min(c.scrollTop()+b,s(e.container[0])),c.animate({scrollTop:b},400),c.css("height",a+"px"))},100)};d.init=function(a){this.loadStylesIn(window);this.siteId=a.site_id;this.root=$nc(a.container).addClass("nc-netshop-condition-editor");this.inputField=$nc("<input type='hidden' name='"+a.input_name+"'/>").appendTo(this.root);var c=a.conditions;c&&!$nc.isEmptyObject(c)&&this.inputField.val(JSON.stringify(c));
this.conditionGroupsToShow=a.groups_to_show||[];this.conditionGroupsToExclude=a.groups_to_exclude||[];this.conditionsToExclude=a.conditions_to_exclude||[];this.load(c);$nc(window).resize($nc.proxy(this,"updateAllConditionLabelPositions"))};d.load=function(a){this.isInitializing=!0;var c=a||{};"string"==typeof a&&(c=JSON&&JSON.parse?JSON.parse(a):eval("("+a+")"));this.root.find(".condition-group").first().remove();this.addGroup(this.root,c);this.isInitializing=!1;var e=this;f(window).load(function(){e.updateAllConditionLabelPositions();
e.root.addClass("enable-transitions")})};d.save=function(){var a=this.getGroupData(this.root.children(".condition-group"));this.inputField.val(a?JSON.stringify(a):"");return a};d.onFormSubmit=function(){return this.checkConditions()?(this.save(),!0):!1};d.getGroupData=function(a){var c={type:a.find(".operator-cell select").val(),conditions:[]},a=a.find(".condition-cell").first().children(".condition, .condition-group"),e=this;if(0==a.length)return null;a.each(function(){var a=f(this);(a=a.hasClass("condition-group")?
e.getGroupData(a):e.getConditionData(a))&&c.conditions.push(a)});return c};d.getConditionData=function(a){var c=a.data("initialValues"),e=!1;a.find(".condition-param-value").not(".condition-param-value-initializing").each(function(){var a=f(this),b=a.val();if(""==b||null==b)return console&&console.warn("Condition parameter %s has no value, the condition is ignored (type=%s)",this.name,c.type),e=!0,!1;a.hasClass("condition-param-value-date")&&a.datepicker&&(b=a.datepicker("getISODate")||b);c[this.name]=
b;return!0});c.type=a.data("conditionType");return e?null:c};d.checkConditions=function(){var a=!0;this.root.find(".condition-param-value").not(".condition-param-value-initializing").each(function(){var c=f(this),e=c.val();if(""==e||null==e)return a=!1,e=c.closest(".condition").find(".condition-string").first().text(),alert(b.VALUE_REQUIRED.replace("%s",e)),c.is("select")?c.data("chosen").selected_item.focus():c.is("input:hidden")?c.siblings("a.condition-param-popup").focus():c.focus(),!1});return a};
d.loadStylesIn=function(a){0==a.$nc("#nc_condition_editor_stylesheet").length&&a.$nc("head").append('<link rel="stylesheet" id="nc_condition_editor_stylesheet" type="text/css" href="'+l+'css/editor.css"><link rel="stylesheet" id="nc_condition_editor_stylesheet" type="text/css" href="'+u+'js/datepicker/datepicker.css">')};d.addGroup=function(a,c){var e=this,k=f("<div class='condition-group'><div class='condition-group-container'><div class='operator-cell'><div class='operator-label nc-label nc--blue'>"+
b.AND+"</div><select class='operator-type'><option value='and'>"+b.AND_DESCRIPTION+"</option><option value='or'>"+b.OR_DESCRIPTION+"</option></select><a class='nc-icon-s nc--remove remove-group-button'></a></div><div class='condition-cell'></div><div class='buttons-cell'><a class='add-condition-button'>"+b.ADD+"</a></div></div></div>"),d=k.find(".condition-cell"),m=k.find("select");k.find(".add-condition-button").click(function(){e.showAddConditionDialog(d)});k.find(".remove-group-button").click(function(){e.removeGroup(k)}).attr("title",
b.REMOVE_GROUP);k.find(".operator-type").change(function(){e.updateConditionLabelText(f(this))});k.find(".operator-label").click(function(){e.changeOperator(f(this))});var h=a.parents(".condition-group"),g=!h.length;g&&k.addClass("root");h.length%2&&k.find(".condition-group-container").addClass("even-level");a.append(k);m.chosen(this.defaultChosenParams);if(f.isEmptyObject(c))g&&k.find(".operator-cell").hide();else{m.val(c.type).change().trigger("chosen:updated");for(var m=0,i=c.conditions.length;m<
i;m++){var n=c.conditions[m];"and"==n.type||"or"==n.type?this.addGroup(d,n):this.addCondition(n.type,d,n)}1==i&&g&&k.find(".operator-cell").hide()}this.updateOperatorLabelPosition(h.first())};d.showAddConditionDialog=function(a){var c=["<option></option>","<option value='addGroup' class='create-group-option'>"+b.ADD_GROUP+"</option>"],e=null,k;for(k in this.conditionTypes){var d=this.conditionTypes[k],h=this.conditionGroupsToShow;if(!(h.length&&-1==f.inArray(d.group,h))&&-1==f.inArray(d.group,this.conditionGroupsToExclude)&&
-1==f.inArray(k,this.conditionsToExclude)){if(e!=d.group)null!=e&&c.push("</optgroup>"),c.push('<optgroup label="'+b[d.group]+'">'),e=d.group;c.push('<option value="'+k+'">'+b[d.label]+"</option>")}}c.push("</optgroup>");var g=f('<select data-placeholder="'+b.SELECT_CONDITION_TYPE+'">'+c.join("")+"</select>"),i=f('<div class="add-condition-type-select"></div>').append(g).appendTo(a),j=this;g.chosen(this.defaultChosenParams).on("chosen:hiding_dropdown",function(){var a=g.val(),c=g.closest(".condition-cell");
g.parents(".add-condition-type-select").remove();"addGroup"==a?j.addGroup(c,null):a&&j.addCondition(a,c,{})}).on("chosen:showing_dropdown",t);setTimeout(function(){i.find(".chosen-container").trigger("mousedown")},1)};d.updateAllConditionLabelPositions=function(){var a=this;this.root.find(".condition-group").each(function(){a.updateOperatorLabelPosition(f(this))})};d.updateOperatorLabelPosition=function(a){if(!this.isInitializing){var c=a.find(".condition-cell").first().children(".condition, .condition-group"),
e=a.find(".operator-cell").first(),b=e.find(".operator-label");if(1<c.length)if(a.is(".root")&&!e.is(":visible"))e.slideDown(400,f.proxy(this,"updateAllConditionLabelPositions")).show();else{var a=b.hasClass("visible"),e=c.first(),d=e.position().top,c=c.last(),h=c.position().top,g=d+27+0.5*(h-d-b.height());e.is(".condition-group")&&(g+=12);c.is(".condition-group")&&(g+=12);g=Math.min(d+f(window).height()-100,Math.round(g))+"px";b.addClass("visible");a?setTimeout(function(){b.css("top",g)},1):b.css("top",
g)}else b.removeClass("visible"),a.is(".root")&&e.is(":visible")&&e.slideUp(400,f.proxy(this,"updateAllConditionLabelPositions"))}};d.updateConditionLabelText=function(a){a.closest(".operator-cell").find(".operator-label").html(b[a.val().toUpperCase()])};d.changeOperator=function(a){a=a.closest(".operator-cell").find(".operator-type");a.val("and"==a.val()?"or":"and").change().trigger("chosen:updated")};d.addCondition=function(a,c,e){var d=this.conditionTypes[a],a=f("<div />",{"class":"condition condition-"+
a,data:{conditionType:a,initialValues:e}}).appendTo(c),h=this;this.addFields(a,d.params,e);f("<a class='nc-icon-s nc--remove remove-condition-button'></a>").click(function(){h.removeCondition(f(this).closest(".condition"))}).attr("title",b.REMOVE_CONDITION).appendTo(a);this.updateOperatorLabelPosition(c.closest(".condition-group"));this.isInitializing||a.find("input, select").not(":hidden").first().focus()};d.addFields=function(a,c,e){for(var b=this,d=e&&!f.isEmptyObject(e),g=0,i=c.length;g<i;g++){var j=
c[g];if("string"==typeof j)a.append("<span class='condition-string'>"+j+"</span>");else{var l="append"+j.type+"Field";void 0===this[l]?console&&console.warn("Incorrect field type '%s': no %s method",j.type,l):this[l](a,j,d?e[j.name]:j.value).wrap(f("<span/>",{"class":"condition-param"}))}}a.find("select").chosen(this.defaultChosenParams).on("chosen:showing_dropdown",t).each(function(){var a=f(this);if(a.data("loadData")){var c=a.data("fieldParams")||{},e=f.proxy(b,"on"+c.type+"ListReady"),c=b.makeFullUrl(c.source||
h.urls[c.type+"List"],c.requestParams);b.loadData(c,e,a.data("callbackParams"))}});a.find("input.condition-param-value-date").datepicker()};d.removeGroup=function(a){var c=0<a.find(".condition").length,e=a.hasClass("root")?b.REMOVE_ALL_CONFIRMATION:b.REMOVE_GROUP_CONFIRMATION;if(!c||confirm(e))a.remove(),this.root.find(".condition-group").length?this.updateAllConditionLabelPositions():this.addGroup(this.root,null)};d.removeCondition=function(a){var c=!1;a.find(".condition-param-value").not(".condition-param-value-initializing").each(function(){var a=
f(this).val();if(""==a||null==a)return c=!0,!1});var e=[];a.find(".condition-string, .condition-param-value:not([type=hidden]), .essence-caption").each(function(){var a=f(this);a.is(".condition-string, .essence-caption")?e.push(a.text()):a.is("select")?e.push("["+f.trim(a.find("option:selected").text())+"]"):e.push(a.val())});if(c||confirm(b.REMOVE_CONDITION_CONFIRMATION.replace("%s",e.join(" "))))a.remove(),this.updateAllConditionLabelPositions()};d.appendSimpleSelectField=function(a,c,e){var b=
['<select name="'+c.name+'">'],d;for(d in c.values)b.push('<option value="'+d+'">'+c.values[d]+"</option>");b.push("</select>");c=f(b.join("")).addClass("condition-param-value");(e||0===e)&&c.val(e);return c.appendTo(a)};d.appendSelectItemField=function(a,c,e){var b=f("<span />"),d=f("<input />",{type:"hidden",name:c.name,value:e,"class":"condition-param-value"}).data("fieldParams",c).appendTo(b),g=f("<a/>",{href:"#","class":"condition-param-popup"}).appendTo(b),h=this;g.click(function(a){h.showItemSelectionDialog(d,
g);a.preventDefault()});this.loadComponentName(e,g);return b.appendTo(a)};d.createListSelectField=function(a,c,e){return f("<select />",{name:a.name,"class":"condition-param-value condition-param-value-initializing condition-param-"+a.type}).data({loadData:!0,fieldParams:a}).attr("data-placeholder",e)};d.appendSelectItemPropertyField=function(a,c,e){return this.createListSelectField(c,e,b.SELECT_ITEM_FIELD).appendTo(a)};d.appendSelectFromClassifierField=function(a,c,e){var d=c.requestParams.classifier;
return this.createListSelectField(c,e,b.SELECT_VALUE).data("callbackParams",{classifier:d}).addClass("condition-param-SelectFromClassifier-"+d).appendTo(a)};d.appendItemPropertyOptionsField=function(a){return f("<span class='condition-itemproperty-variable-part' />").appendTo(a)};d.appendInputField=function(a,c,e){return f("<input />",{type:c.inputType||"text",name:c.name,value:e,autocomplete:"off","class":"condition-param-value"+(c["class"]?" "+c["class"]:"")}).appendTo(a)};d.appendDateTimeInputField=
function(a,c,e){return f("<input />",{type:"text",name:c.name,value:e,"class":"condition-param-value condition-param-value-date"}).appendTo(a)};d.appendSelectUserField=function(a,c,e){var b=f("<span />"),d=f("<input />",{type:"hidden",name:c.name,value:e,"class":"condition-param-value"}).appendTo(b),g=f("<a/>",{href:"#","class":"condition-param-popup"}).appendTo(b),h=this;g.click(function(a){h.showUserSelectionDialog(d,g);a.preventDefault()});this.loadUserName(e,g);return b.appendTo(a)};d.appendSelectUserPropertyField=
function(a,c,e){return this.createListSelectField(c,e,b.SELECT_USER_PROPERTY).appendTo(a)};d.appendUserPropertyOptionsField=function(a){return f("<span class='condition-userproperty-variable-part' />").appendTo(a)};d.appendSelectOrderPropertyField=function(a,c,e){return this.createListSelectField(c,e,b.SELECT_ORDER_PROPERTY).appendTo(a)};d.getSelectFromJsonClass=function(a){for(var c=0,e=0,b=a.length;e<b;e++)c=(c<<5)-c+a.charCodeAt(e),c&=c;c=c.toString(36).replace("-","N");return"condition-param-SelectFromJson-"+
c};d.appendSelectFromJsonField=function(a,c,b){var d=this.makeFullUrl(c.source,c.requestParams);return this.createListSelectField(c,b,c.placeholder).addClass(this.getSelectFromJsonClass(d)).appendTo(a)};d.appendOrderPropertyOptionsField=function(a){return f("<span class='condition-orderproperty-variable-part' />").appendTo(a)};d.showItemSelectionDialog=function(a,c){nc.load_dialog(l+"dialogs/select_item_dialog.php?site_id="+this.siteId).set_options({condition_dialog_target_input:a,condition_dialog_target_caption:c})};
d.showUserSelectionDialog=function(a,c){nc.load_dialog(l+"dialogs/select_user_dialog.php?site_id="+this.siteId).set_options({condition_dialog_target_input:a,condition_dialog_target_caption:c})};d.loadData=function(a,c,b){if(!c)c=f.noop;h.loadingInProgress[a]||("undefined"==typeof h.dataCache[a]?(h.loadingInProgress[a]=!0,f.getJSON(a,function(d){h.dataCache[a]=d;c(d,a,b);h.loadingInProgress[a]=!1})):c(h.dataCache[a],a,b))};d.makeFullUrl=function(a,c){var b=a;c&&(b+=(0<=b.indexOf("?")?"&":"?")+f.param(c));
return b.replace("%siteId%",this.siteId)};d.fillSelectsWithOptions=function(a,c){var b=this.root.find(a);if(0<b.length){var d=["<option></option>"];if(f.isArray(c))for(var g=0,h=c.length;g<h;g++)d.push('<option value="'+c[g].key+'">'+c[g].value+"</option>");b.append(d.join(""));this.reinitializeChosenSelects(b)}};d.reinitializeChosenSelects=function(a){a.each(function(){var a=f(this),b=a.data("chosen");a.data("hadFocus",b?b.container.hasClass("chosen-container-active"):a.is(":focus"));a.val((a.closest(".condition").data("initialValues")||
{})[a.attr("name")]).removeClass("condition-param-value-initializing")}).chosen("destroy").chosen(this.defaultChosenParams).each(function(){var a=f(this);a.data("hadFocus")&&a.data("chosen").selected_item.focus();a.removeData("hadFocus")})};d.onSelectFromClassifierListReady=function(a,c,b){this.fillSelectsWithOptions("select.condition-param-SelectFromClassifier-"+b.classifier+":empty",a)};d.onSelectItemPropertyListReady=function(a){this.itemProperties=a;var c=["<option></option>"],b;for(b in a){c.push('<optgroup label="'+
b+'">');for(var d=0,g=a[b].length;d<g;d++){var h=a[b][d];c.push("<option value='"+h.id+"'>"+h.description+"</option>")}c.push("</optgroup>")}a=this.root.find("select.condition-param-SelectItemProperty:empty");a.append(c.join("")).change(f.proxy(this,"onItemPropertySelect"));this.reinitializeChosenSelects(a);a.trigger("change")};d.generatePropertyFieldConfiguration=function(a){var c=[];switch(a.type){case "string":case "text":c.push(q,{name:"value",type:"Input"});break;case "integer":c.push(g,{name:"value",
type:"Input",inputType:"number"});break;case "float":c.push(g,{name:"value",type:"Input"});break;case "select":case "multiselect":c.push("multiselect"==a.type?v:j,{name:"value",type:"SelectFromClassifier",requestParams:{classifier:a.classifier}});break;case "boolean":c.push('<input type="hidden" name="op" value="eq" class="condition-param-value">'+b.EQUALS,{name:"value",type:"SimpleSelect",values:{1:b.TRUE,"0":b.FALSE}});break;case "datetime":c.push(r,{name:"value",type:"DateTimeInput"})}return c};
d.onItemPropertySelect=function(a){var c=f(a.target);if(a=this.getItemPropertyData(c.val())){var b=c.closest(".condition"),c=b.find(".condition-itemproperty-variable-part"),b=b.data("initialValues"),a=this.generatePropertyFieldConfiguration(a);c.html("");this.addFields(c,a,b)}};d.getItemPropertyData=function(a){var c=this.itemProperties,b;for(b in c)for(var d=0,f=c[b].length;d<f;d++){var g=c[b][d];if(g.id==a)return g}return null};d.onSelectFromJsonListReady=function(a,c){this.fillSelectsWithOptions("select."+
this.getSelectFromJsonClass(c)+":empty",a)};d.onSelectUserPropertyListReady=function(a){this.userProperties=a;var c=["<option></option>"],b;for(b in a)c.push("<option value='"+b+"'>"+a[b].description+"</option>");a=this.root.find("select.condition-param-SelectUserProperty:empty");a.append(c.join("")).change(f.proxy(this,"onUserPropertySelect"));this.reinitializeChosenSelects(a);a.trigger("change")};d.onUserPropertySelect=function(a){var c=f(a.target);if(a=this.userProperties[c.val()]){var b=c.closest(".condition"),
c=b.find(".condition-userproperty-variable-part"),b=b.data("initialValues"),a=this.generatePropertyFieldConfiguration(a);c.html("");this.addFields(c,a,b)}};d.onSelectOrderPropertyListReady=function(a){this.orderProperties=a;var b=["<option></option>"],d;for(d in a)b.push("<option value='"+d+"'>"+a[d].description+"</option>");a=this.root.find("select.condition-param-SelectOrderProperty:empty");a.append(b.join("")).change(f.proxy(this,"onOrderPropertySelect"));this.reinitializeChosenSelects(a);a.trigger("change")};
d.onOrderPropertySelect=function(a){var b=f(a.target);if(a=this.orderProperties[b.val()]){var d=b.closest(".condition"),b=d.find(".condition-orderproperty-variable-part"),d=d.data("initialValues"),a=this.generatePropertyFieldConfiguration(a);b.html("");this.addFields(b,a,d)}};d.loadComponentName=function(a,c){/^\d+:\d+$/.test(a)?f.getJSON(h.urls.ObjectName,{object:a},function(a){var d=b.NONEXISTENT_ITEM;a&&a.Message_ID&&(d="<span class='essence-id'>"+a.Message_ID+"</span>. <span class='essence-caption'>"+
(a.FullName||b.ITEM_WITHOUT_NAME)+"</span>");c.html(d)}):c.html("<span class='not-selected'>"+b.SELECT_ITEM+"</span>")};d.loadUserName=function(a,c){/^\d+$/.test(a)?f.getJSON(h.urls.UserName,{user_id:a},function(a){var d=b.NONEXISTENT_USER;a&&a.User_ID&&(d="<span class='essence-id'>"+a.User_ID+"</span>. <span class='essence-caption'>"+a.Name+"</span>");c.html(d)}):c.html("<span class='not-selected'>"+b.SELECT_USER+"</span>")}})($nc);
